name: CI Pipeline

on:
  pull_request:
    types: [closed]
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Run tests
      run: echo "Running tests..."

    - name: Notify Slack
      run: |
        curl -X POST -H 'Content-type: application/json' \
        --data '{"text":"ðŸŽ‰ Issue Ä‘Ã£ Ä‘Æ°á»£c Ä‘Ã³ng vÃ  PR Ä‘Ã£ merge!"}' \
        ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Move Jira issue to Done
      env:
        JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        JIRA_DOMAIN: your-domain.atlassian.net
      run: |
        ISSUE_KEY=$(echo "${{ github.event.pull_request.title }}" | grep -o 'TODO-[0-9]\+')
        echo "Issue key found: $ISSUE_KEY"
        curl -u "$JIRA_EMAIL:$JIRA_API_TOKEN" \
          -X POST \
          -H "Content-Type: application/json" \
          --data '{"transition":{"id":"31"}}' \
          https://$JIRA_DOMAIN/rest/api/3/issue/$ISSUE_KEY/transitions
